---
title: "Supplemental Information"
author: "Dan"
date: "5/15/2017"
output: html_document
---

```{r setup, include=FALSE}
source("~/Flanks/setup.R")
```

## Table S1: Read depths
```{r}
 depth %>% 
  rename(Protein = protein, Replicate = rep, Bound = TF, Input = IN) %>% 
  mutate(Protein = ifelse(Protein == "pho4","Pho4","Cbf1")) %>% 
  arrange(desc(Protein)) %>% 
  xtable() %>% 
  print()
```

## Table S2: Raw per-sequence ddG cross correlation results
```{r}
longCounts = 
  counts.df %>% 
  mutate(protein = ifelse(protein == "pho4", "Pho4", "Cbf1")) %>% 
  unite("newcol", protein, rep) %>% 
  select(flank, ddG, newcol) %>% 
  spread(newcol,ddG)

cor(longCounts %>% select(-flank) %>% as.matrix(), use = "complete.obs")^2 %>% 
  as.data.frame.matrix() %>% 
  mutate(Var1 = rownames(.)) %>% 
  gather(Var2,r,-Var1) %>% 
  mutate(Var1 = sub("_"," #",Var1),
         Var2 = sub("_"," #",Var2)) %>% 
  tbl_df() %>% 
  distinct() %>% 
  mutate(pass = ifelse(as.integer(substr(Var1,nchar(Var1),nchar(Var1))) < as.integer(substr(Var2,nchar(Var2),nchar(Var2))) & substring(Var1,1,4) == substring(Var2,1,4),1,0),
         Var1 = factor(Var1, levels = c(paste("Pho4",1:4,sep=" #"), paste("Cbf1",1:3,sep=" #"))),
         Var2 = factor(Var2, levels = c(paste("Pho4",1:4,sep=" #"), paste("Cbf1",1:3,sep=" #")))) %>% 
  filter(pass == 1) %>% 
  select(-pass) %>% 
  arrange(Var1,Var2) %>% 
  xtable(digits = 2) %>% 
  print() 
```

## Table S3: Pho4 Kd results
```{r}
right_join(fread("~/Google\ Drive/Flanks_data/std_kd_cbf1.csv") %>% 
      select(Sequence,cbf1 = estimate, cbf1err = std.error) %>% 
      mutate(core = substr(Sequence,23,28),
             Sequence = paste(substr(Sequence,17,21),substr(Sequence,30,34),sep="_"),
             Sequence = ifelse(core == "CAGCTG", "negative control", Sequence),
             cbf1 = round(cbf1),
             cbf1err = round(cbf1err)),
      fread("~/Google\ Drive/Flanks_data/std_kd_pho4.csv") %>% 
      select(Sequence,pho4 = estimate, pho4err = std.error) %>% 
      mutate(core = substr(Sequence,23,28),
             Sequence = paste(substr(Sequence,17,21),substr(Sequence,30,34),sep="_"),
             Sequence = ifelse(core == "CAGCTG", "negative control", Sequence),
             pho4 = round(pho4),
             pho4err = round(pho4err))) %>% 
  arrange(pho4,cbf1) %>% 
  select(Sequence, pho4, pho4err, cbf1, cbf1err) %>% 
  xtable(digits = 0) %>% 
  print() 
```

## Table S4: NN-derived linear model correlation to NN-derived individual ddG
```{r}
# Held-out r^2
training_data <- fread("~/Google Drive/Flanks_data/train_seqs.txt", header = FALSE) %>% 
  rename(flank = V1)

model_outputs %>%
  anti_join(., training_data) %>% 
  group_by(model, dataset) %>%
  summarize(r2 = cor(scaled_ddG, .fitted)^2) %>% 
  ungroup() %>% 
  mutate(dataset = factor(dataset, levels = c("Pho4", "Cbf1")),
         model = gsub("-","",model),
         model = factor(model, levels = c("mononucleotide", "nearest neighbor", "dinucleotide"))) %>%
  arrange(dataset,r2) %>% 
  select(dataset,model,r2) %>% 
  xtable(digits = 2) %>% 
  print()
```

## Table S5: Cross correlation of mononucleotide model coefficients
```{r}
training_data <- fread("~/Google Drive/Flanks_data/train_seqs.txt", header = FALSE) %>% 
  rename(flank = V1)

lmCross = foreach(i = counts.df$protein %>% unique(), .combine = "rbind")%do%{
  iSlice = counts.df %>% filter(protein == i) 
  foreach(j = iSlice$rep %>% unique(), .combine = "rbind")%do%{
    jSlice = iSlice %>% filter(rep == j) %>% left_join(training_data,.)
    mod = lm(ddG ~ X01 + X02 + X03 + X04 + X05 + X06 + X07 + X08 + X09 + X10, data = jSlice)
    tidy(mod) %>% mutate(rep = j, protein = ifelse(i == "pho4","Pho4","Cbf1"))
  }
} %>% unite(type,protein,rep) %>%
  select(type,estimate,term) %>%
  spread(type,estimate)

pairedDf = 
  makePairs(lmCross, "term") %>% 
  mutate(xvar = factor(xvar, 
                       levels = c(paste("Pho4",1:4,sep="_"), paste("Cbf1",1:3,sep="_")),
                       labels = c(paste("Pho4",1:4,sep=" #"), paste("Cbf1",1:3,sep=" #"))),
         yvar = factor(yvar, 
                       levels = c(paste("Pho4",1:4,sep="_"), paste("Cbf1",1:3,sep="_")),
                       labels = c(paste("Pho4",1:4,sep=" #"), paste("Cbf1",1:3,sep=" #"))))

# return correlation coefficients
corr_val = 
  cor(pairedDf %>% select_(.dots = c(paste("Pho4",1:4,sep="_"), paste("Cbf1",1:3,sep="_"))))^2 %>% 
  as.data.frame.matrix() %>% 
  mutate(Var1 = rownames(.)) %>% 
  gather(Var2,r,-Var1) %>% 
  mutate(Var1 = sub("_"," #",Var1),
         Var2 = sub("_"," #",Var2)) %>% 
  tbl_df() %>% 
  distinct() %>% 
  mutate(pass = ifelse(as.integer(substr(Var1,nchar(Var1),nchar(Var1))) < as.integer(substr(Var2,nchar(Var2),nchar(Var2))),1,0),
         Var1 = factor(Var1, levels = c(paste("Pho4",1:4,sep=" #"), paste("Cbf1",1:3,sep=" #"))),
         Var2 = factor(Var2, levels = c(paste("Pho4",1:4,sep=" #"), paste("Cbf1",1:3,sep=" #")))) %>% 
  filter(pass == 1) %>% 
  select(-pass) %>% 
  arrange(desc(r))

# output table
corr_val %>% 
  xtable(digits = 2) %>% 
  print() 

# calculate error in kcal/mol
corr_val %>% 
  mutate(err = 1-r) %>% 
  filter(substring(Var1,1,4) == substring(Var2,1,4)) %>% 
  mutate(protein = substring(Var1,1,4)) %>% 
  group_by(protein) %>% 
  summarise(maxval = max(err),
            minval = min(err)) %>% 
  left_join(.,outAdd %>% # ranges from NN-derived mononucleotide model
    group_by(protein) %>% 
    summarise(range = max(monuc.meanval)-min(monuc.meanval))) %>% 
  mutate(ddG_max = maxval*range,
         ddG_min = minval*range)
```


##############################


## Figure S1A: Monte Carlo parameter grid
```{r, warning=FALSE, message=FALSE, fig.width=10, fig.height=10}
# read data
returnDf2 =
  fread("~/Google Drive/Flanks_data/modelSimulation.txt", header = T) %>%
  group_by(libSize, ddG, readTotal) %>%
  mutate(r2 = r2/seqObsPct,
         medr2 = median(r2, na.rm =T), 
         medseqObsPct = median(seqObsPct, na.rm = T), 
         fold = exp(ddG/.593)) %>% 
  ungroup() %>% 
  mutate(readTotal = log10(readTotal),
         readTotal = factor(readTotal, labels = c(
           expression(bold(paste("depth = 10"^"3"))),
           expression(bold(paste("depth = 10"^"4"))),
           expression(bold(paste("depth = 10"^"5"))),
           expression(bold(paste("depth = 10"^"6"))),
           expression(bold(paste("depth = 10"^"7"))),
           expression(bold(paste("depth = 10"^"8"))))),
         libSize = log10(libSize),
         libSize = factor(libSize, labels = c(
           expression(bold(paste("lib. size = 10"^"2"))),
           expression(bold(paste("lib. size = 10"^"3"))),
           expression(bold(paste("lib. size = 10"^"4"))),
           expression(bold(paste("lib. size = 10"^"5"))),
           expression(bold(paste("lib. size = 10"^"6"))))))

# plot accuracy
S1A = ggplot(returnDf2) +
  presentation +
  geom_line(aes(ddG, medr2), color = "red", na.rm = T, size = 0.2) +
  geom_boxplot(aes(ddG, r2, group = ddG), outlier.alpha = 0, width = 0.5, na.rm = T, size = 0.2) +
  theme(aspect.ratio = 1) +
  facet_grid(readTotal ~ libSize, labeller = "label_parsed") +
  ylim(c(0,1)) +
  ylab(expression(bold(paste("Pearson's r"^"2")))) +
  xlab(expression(bold(paste(Delta, Delta, "G range, kcal/mol"))))

ggsave("~/Flanks/Images/S1A.png", plot = S1A, height = 13, width = 13, units = "cm")
ggsave("~/Flanks/Images/S1A.eps", plot = S1A, height = 13, width = 13, units = "cm")

# plot faction observed
S1B = ggplot(returnDf2) +
  presentation +
  geom_line(aes(ddG, medseqObsPct), color = "red", size = 0.2) +
  geom_boxplot(aes(ddG, seqObsPct, group = ddG), outlier.alpha = 0, width = 0.5, size = 0.2) +
  theme(aspect.ratio = 1) +
  facet_grid(readTotal ~ libSize, labeller = "label_parsed") +
  ylim(c(0,1)) +
  ylab("Fraction of library observed") +
  xlab(expression(bold(paste(Delta, Delta, "G range, kcal/mol"))))

ggsave("~/Flanks/Images/S1B.png", plot = S1B, height = 13, width = 13, units = "cm")
ggsave("~/Flanks/Images/S1B.eps", plot = S1B, height = 13, width = 13, units = "cm")
```

## Figure S2: Replicate raw ddG distributions
```{r}
S2 = ggplot(counts.df %>% 
         mutate(protein = ifelse(protein == "pho4", "Pho4", "Cbf1"),
                protein = factor(protein,
                                levels = c("Pho4", "Cbf1")),
                rep = paste0("rep #",rep))) + 
  presentation +
  theme(aspect.ratio = 1) +
  geom_histogram(aes(ddG)) +
  facet_grid(protein ~ rep) +
  xlab(expression(bold(paste(Delta, Delta, "G, kcal/mol")))) +
  ylab("Count")

ggsave("~/Flanks/Images/S2.png",S2, height = 5, width = 10, units = "cm")
ggsave("~/Flanks/Images/S2.eps",S2, height = 5, width = 10, units = "cm")
```

## Figure S3: raw ddG among Pho4 replicates
```{r}
wideTable = 
  bind_rows(left_join(counts.df %>% 
              filter(protein == "pho4", rep == 3) %>% 
              mutate(protein = ifelse(protein == "pho4", "Pho4", "Cbf1")) %>% 
              select(flank, Pho4_1 = ddG),
            counts.df %>% 
              filter(protein == "pho4", rep == 4) %>% 
              mutate(protein = ifelse(protein == "pho4", "Pho4", "Cbf1")) %>% 
              select(flank, Pho4_2 = ddG)) %>% mutate(depth = "depth = 24 million"),
            left_join(counts.df %>% 
              filter(protein == "pho4", rep == 1) %>% 
              mutate(protein = ifelse(protein == "pho4", "Pho4", "Cbf1")) %>% 
              select(flank, Pho4_1 = ddG),
            counts.df %>% 
              filter(protein == "pho4", rep == 2) %>% 
              mutate(protein = ifelse(protein == "pho4", "Pho4", "Cbf1")) %>% 
              select(flank, Pho4_2 = ddG)) %>% mutate(depth = "depth = 6-8 million")) %>% 
  mutate(depth = factor(depth, levels = c("depth = 6-8 million","depth = 24 million")))

  
# all cross pairs
S3 = ggplot(wideTable) + 
  presentation +
  geom_hex(aes(Pho4_1,Pho4_2), bins = 50) + 
  theme(aspect.ratio = 1,
        legend.key.size = unit(0.3,"cm")) +
  ylab("Pho4 replicate B") +
  xlab("Pho4 replicate A") +
  scale_fill_gradient2(name = "Count",
                       trans = "log",
                       low = "black", mid = "red", high = "yellow",
                       midpoint = 6,
                       breaks = c(1, 10, 100, 1000, 10000)) +
  facet_grid(. ~ depth)

ggsave("~/Flanks/Images/S3.png",S3, height = 5, width = 10, units = "cm")
ggsave("~/Flanks/Images/S3.eps",S3, height = 5, width = 10, units = "cm")
```

## Figure S4: Neural network training curves
```{r}
cbf1_training <- read.table("~/Google\ Drive/Flanks_data/cbf1_model.acc", header = TRUE) %>% 
  gather(dataset, RMSE, -epoch) %>% 
  mutate(dataset = ifelse(dataset == "train_acc", "training", "validation"),
         protein = "Cbf1")

pho4_training <- read.table("~/Google\ Drive/Flanks_data/pho4_model.acc", header = TRUE) %>% 
  gather(dataset, RMSE, -epoch) %>% 
  mutate(dataset = ifelse(dataset == "train_acc", "training", "validation"),
         protein = "Pho4")

training_data <- bind_rows(cbf1_training, pho4_training) %>% 
  mutate(protein = factor(protein, levels = c("Pho4", "Cbf1")))

colPal = brewer.pal(9,"Set1")
S4 = ggplot(training_data, aes(epoch, RMSE, color = dataset)) +
  geom_line() + 
  presentation +
  scale_color_manual("",values = colPal[1:2]) +
  xlab("Epoch") +
  presentation +
  theme(aspect.ratio = 1,
        legend.key.size = unit(0.3,"cm")) +
  facet_grid(protein ~ ., scales = "free_y")

ggsave("~/Flanks/Images/S4.png", S4, height = 5, width = 7, units = "cm")
ggsave("~/Flanks/Images/S4.eps", S4, height = 5, width = 7, units = "cm")
```

## Figure S5: NN-derived ddG histograms
```{r}
S5 = ggplot(countsNN_scaled %>% 
         mutate(protein = ifelse(protein == "pho4", "Pho4", "Cbf1"),
                protein = factor(protein,
                                levels = c("Pho4", "Cbf1")))) + 
  presentation +
  theme(aspect.ratio = 1) +
  geom_histogram(aes(NN_ddG)) +
  facet_grid(. ~ protein) +
  xlab(expression(bold(paste("Neural network predicted ", Delta, Delta, "G, kcal/mol")))) +
  ylab("Count")

ggsave("~/Flanks/Images/S5.png", S5, height = 5, width = 7, units = "cm")
ggsave("~/Flanks/Images/S5.eps", S5, height = 5, width = 7, units = "cm")
```

## Figure S6: Individual Pho4 + Cbf1 titration binding curves
```{r}
colPal = colorRampPalette(c("#0057E7", "#D62D20"))(32)
pho4Curves = 
  fread("~/Google Drive/Flanks_data/pho4BindingCurves.csv", sep = ",", header = T) %>%
  tbl_df() %>%
  rename(ID = Onum, fBound = R, Conc = Ch) %>%
  mutate(index = paste("ID",ID,sep=""), index = factor(index, paste0("ID",1:32))) %>%
  createCurves(.) %>%
  mutate(index = factor(index, levels = paste0("ID",1:32))) %>%
  left_join(.,fread("~/Google Drive/Flanks_data/seq2ID_pho4.txt", header = F) %>%
    unite("flank",V3,V5,sep="_") %>%
    select(index = V1, flank) %>%
    mutate(index = paste("ID",index,sep=""))) %>%
  mutate(flank = ifelse(index == "ID32","negative control",flank)) %>%
  mutate(flank = factor(flank, levels = arrange(.,estimate) %>% .$flank %>% unique()))

S6A = ggplot(pho4Curves) +
  geom_point(aes(Conc,fBound,color=flank), size = 0.01) +
  geom_line(aes(Conc,.fitted,color=flank), size = 0.2) +
  presentation +
  theme(aspect.ratio = 1, 
        legend.position = "none",
        axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.spacing = unit(0.2, "lines")) +
  ylab("Intensity ratio (DNA/protein)") +
  xlab("DNA concentration, nM") + 
  facet_wrap( ~ flank, nrow=6) +
  scale_color_manual(values = (colPal))

ggsave("~/Flanks/Images/S6A.png", plot = S6A, height = 17, width = 13, units = "cm")
ggsave("~/Flanks/Images/S6A.eps", plot = S6A, height = 17, width = 13, units = "cm")

cbf1Curves = 
  fread("~/Google Drive/Flanks_data/cbf1BindingCurves.csv", sep = ",", header = T) %>%
  tbl_df() %>%
  rename(ID = Onum, fBound = R, Conc = Ch) %>%
  mutate(index = paste("ID",ID,sep=""), index = factor(index, paste0("ID",1:32))) %>%
  createCurves(.) %>%
  mutate(index = factor(index, levels = paste0("ID",1:32))) %>%
  left_join(.,fread("~/Google Drive/Flanks_data/seq2ID_cbf1.txt", header = F) %>%
    unite("flank",V3,V5,sep="_") %>%
    select(index = V1, flank) %>%
    mutate(index = paste("ID",index,sep=""))) %>%
  mutate(flank = ifelse(index == "ID32","negative control",flank)) %>%
  mutate(flank = factor(flank, levels = arrange(.,estimate) %>% .$flank %>% unique()))

S6B = ggplot(cbf1Curves) +
  geom_point(aes(Conc,fBound,color=flank), size = 0.01) +
  geom_line(aes(Conc,.fitted,color=flank), size = 0.2) +
  presentation +
  theme(aspect.ratio = 1, 
        legend.position = "none",
        axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.spacing = unit(0.2, "lines")) +
  ylab("Intensity ratio (DNA/protein)") +
  xlab("DNA concentration, nM") + 
  facet_wrap( ~ flank, nrow=6) +
  scale_color_manual(values = (colPal))

ggsave("~/Flanks/Images/S6B.png", plot = S6B, height = 17, width = 13, units = "cm")
ggsave("~/Flanks/Images/S6B.eps", plot = S6B, height = 17, width = 13, units = "cm")
```

## Figure S7: Histogram of core vs flank
```{r}
coreDf = 
  fread("~/Google Drive/Flanks_data/core_mutation_ddG.txt", header = T) %>% 
  tbl_df() %>% 
  mutate(type = "core") %>% 
  bind_rows(.,countsNN_scaled %>%
  select(sequence = flank, ddG = scaled_dG, protein) %>% 
  group_by(protein) %>% 
  mutate(ddG = ddG-min(ddG),
         type = "flank") %>% 
  ungroup()) %>% 
  mutate(protein = ifelse(protein == "pho4","Pho4","Cbf1"),
         protein = factor(protein, levels = c("Pho4","Cbf1")))

colPal = brewer.pal(9,"Set1")
S7 = ggplot(coreDf) +
  presentation +
  theme(aspect.ratio = 1,
        legend.key.size = unit(0.3,"cm"),
        legend.key = element_rect(size = 0.25)) +
  geom_density(aes(ddG, fill = type), size = 0.25) +
  facet_grid(. ~ protein) +
  ylab("Density") +
  xlab(expression(bold(paste(Delta, Delta, "G, kcal/mol")))) +
  scale_fill_manual("", values = colPal[1:2])

ggsave("~/Flanks/Images/S7.png", plot = S7, height = 4.5, width = 8.7, units = "cm")
ggsave("~/Flanks/Images/S7.eps", plot = S7, height = 4.5, width = 8.7, units = "cm")

```

## Figure S8: Individual replicate binding preferences
```{r}
outAdd = addMotif(counts.df, "ddG") %>% 
  mutate(monuc.value = factor(monuc.value, levels = c("T","G","C","A")))

relAdd = foreach(i = c("pho4","cbf1"), .combine = "rbind")%do%{
  iSlice = outAdd %>% filter(protein == i) %>% rename(totalmean = monuc.meanval)
  foreach(j = iSlice$rep %>% unique(), .combine = "rbind")%do%{
    jSlice = iSlice %>% filter(rep == j)
    minRow = jSlice %>% filter(totalmean == min(totalmean))
    jSlice %>%
      mutate(affinityFrac = totalmean/minRow$totalmean,
             protein = i,
             rep = j)
}} %>% mutate(protein = factor(protein, levels = c("pho4","cbf1"))) %>%
  left_join(.,depth %>% group_by(protein,rep) %>% summarise(count = min(c(TF,IN)), count = round(count/1E6))) %>%
  mutate(protein = ifelse(protein == "pho4","Pho4","Cbf1"),
         protein = factor(protein, 
                          levels = c("Pho4","Cbf1"),
                          labels = c(
                            expression(bold(paste("Pho4"))),
                            expression(bold(paste("Cbf1")))
                          )),
         count = factor(count, labels = c(
           expression(bold(paste("depth = 5 x 10"^"6"))),
           expression(bold(paste("depth = 6 x 10"^"6"))),
           expression(bold(paste("depth = 8 x 10"^"6"))),
           expression(bold(paste("depth = 14 x 10"^"6"))),
           expression(bold(paste("depth = 24 x 10"^"6")))
         )),
         rep = factor(rep, labels = c(
           expression(bold(paste("rep = 1"))),
           expression(bold(paste("rep = 2"))),
           expression(bold(paste("rep = 3"))),
           expression(bold(paste("rep = 4")))
         ))) %>% 
  left_join(., data.frame(monuc.value = c("A","C","G","T"), colPal = c("#55C341","#3036DF","#F0E328","#EF1717"))) %>% 
  mutate(colPal = as.character(colPal))

# composite textmap
S8 = ggplot(relAdd,aes(monuc.pos, affinityFrac)) +
  presentation +
  geom_text(aes(label = monuc.value, color = monuc.value), size = 2) +
  theme(aspect.ratio = 1, 
        legend.position = "none",
        axis.text.x = element_text(angle = 45),
        panel.spacing = unit(0.1, "lines")) +
  ylab("Relative affinity") +
  xlab("Flank position") +
  facet_wrap(~ protein+rep+count, nrow = 2, labeller = "label_parsed") +
  scale_color_manual(values = c("#55C341","#3036DF","#F0E328","#EF1717"))

ggsave("~/Flanks/Images/S8.png", plot = S8, height = 10, width = 10, units = "cm")
ggsave("~/Flanks/Images/S8.eps", plot = S8, height = 10, width = 10, units = "cm")
```

## Figure S9: Cross replication of mononucleotide model coefficients
```{r}
training_data <- fread("~/Google Drive/Flanks_data/train_seqs.txt", header = FALSE) %>% 
  rename(flank = V1)

lmCross = foreach(i = counts.df$protein %>% unique(), .combine = "rbind")%do%{
  iSlice = counts.df %>% filter(protein == i) 
  foreach(j = iSlice$rep %>% unique(), .combine = "rbind")%do%{
    jSlice = iSlice %>% filter(rep == j) %>% left_join(training_data,.)
    mod = lm(ddG ~ X01 + X02 + X03 + X04 + X05 + X06 + X07 + X08 + X09 + X10, data = jSlice)
    tidy(mod) %>% mutate(rep = j, protein = ifelse(i == "pho4","Pho4","Cbf1"))
  }
} %>% unite(type,protein,rep) %>%
  select(type,estimate,term) %>%
  spread(type,estimate)

pairedDf = 
  makePairs(lmCross, "term") %>% 
  mutate(xvar = factor(xvar, 
                       levels = c(paste("Pho4",1:4,sep="_"), paste("Cbf1",1:3,sep="_")),
                       labels = c(paste("Pho4",1:4,sep=" #"), paste("Cbf1",1:3,sep=" #"))),
         yvar = factor(yvar, 
                       levels = c(paste("Pho4",1:4,sep="_"), paste("Cbf1",1:3,sep="_")),
                       labels = c(paste("Pho4",1:4,sep=" #"), paste("Cbf1",1:3,sep=" #"))))

S9 = ggplot(pairedDf, aes_string(x = "x", y = "y")) + 
  presentation +
  facet_grid(xvar ~ yvar, scales = "free") + 
  geom_point(size = 0.01) + 
  theme(aspect.ratio = 1, 
        axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.spacing = unit(0.1, "lines")) +
  ylab("Model coefficient") +
  xlab("Model coefficient")

ggsave("~/Flanks/Images/S9.png", plot = S9, height = 10, width = 10, units = "cm")
ggsave("~/Flanks/Images/S9.eps", plot = S9, height = 10, width = 10, units = "cm")
```

## Figure S10: eGFP control binding preference
```{r}
# additive model plots
outAdd = addMotif(fread("~/Google Drive/Flanks_data/countsGF.txt", header = T) %>% 
                    na.omit() %>% 
                    filter(!is.infinite(ddG)) %>%
                    group_by(rep) %>%
                    mutate(ddG = ddG-mean(ddG)) %>% # mean-center
                    ungroup(), "ddG") %>% 
  mutate(monuc.value = factor(monuc.value, levels = c("T","G","C","A"))) %>%  
  group_by(monuc.value,monuc.pos,side) %>% 
  summarise(totalmean = mean(monuc.meanval), sem = sd(monuc.meanval)/sqrt(n())) %>% # SEM across replicates
  ungroup()

minRow = outAdd %>% filter(totalmean == min(totalmean))

relAdd = 
  outAdd %>%
    mutate(affinitySEM = sqrt(((sem/totalmean)^2)+((minRow$sem/minRow$totalmean)^2)), 
           affinityFrac = totalmean/minRow$totalmean,
           affinitySEM = abs(affinityFrac*affinitySEM)) %>% 
    left_join(., data.frame(monuc.value = c("A","C","G","T"), colPal = c("#55C341","#3036DF","#F0E328","#EF1717"))) %>%
    mutate(colPal = as.character(colPal))

# composite textmap
S10 = ggplot(relAdd,aes(monuc.pos, affinityFrac)) +
  presentation +
  geom_errorbar(aes(x = monuc.pos, ymin = affinityFrac - affinitySEM, ymax = affinityFrac + affinitySEM),size = 0.1,width=0.1) +
  geom_text(aes(label = monuc.value, color = monuc.value), size = 2) +
  theme(aspect.ratio = 1, 
        legend.position = "none",
        axis.text.x = element_text(angle = 45)) +
  ylab("Relative affinity") +
  xlab("Flank position") +
  scale_color_manual(values = c("#55C341","#3036DF","#F0E328","#EF1717"))

ggsave("~/Flanks/Images/S10.png", plot = S10, height = 5, width = 5, units = "cm")
ggsave("~/Flanks/Images/S10.eps", plot = S10, height = 5, width = 5, units = "cm")
```

## Figure S11: Cbf1 + Pho4 LASSO 10-fold CV confidence interval + extracted coefficients table
```{r}
cvLasso = bind_rows(fread("~/Google Drive/Flanks_data/lassoCV_pho4.txt", header = T) %>% mutate(protein = "Pho4"),
                    fread("~/Google Drive/Flanks_data/lassoCV_cbf1.txt", header = T) %>% mutate(protein = "Cbf1")) %>%
  mutate(protein = factor(protein, levels = c("Pho4","Cbf1")))

# CV plot
S11 = ggplot(cvLasso) +
  presentation + 
  geom_errorbar(aes(x = lambda, ymax = conf.high, ymin = conf.low), size = 0.20) +
  theme(aspect.ratio = 1) +
  scale_x_log10() +
  xlab(expression(bold(paste("Penalty coefficient, log(", lambda,")")))) +
  ylab("Mean squared error") +
  facet_grid(protein ~ ., scales = "free")

ggsave("~/Flanks/Images/S11.png", plot = S11, height = 7, width = 7, units = "cm")
ggsave("~/Flanks/Images/S11.eps", plot = S11, height = 7, width = 7, units = "cm")

# protVal = "cbf1"
# dfVar = fread(paste0("~/Flank_seq/data/dfVar_",protVal,".txt"), header = T)
# dfVar %>% select(Flank = flank, Coefficient = coef) %>% filter(Coefficient != 0) %>% arrange(Coefficient) %>% slice(1:20)
```

## INCLUDE CSV: LASSO
```{r}
write.table(cvLasso, "~/Google Drive/Flanks_data/SuppData/supp_data1.csv", sep = ",", row.names = F, col.names = T, quote = F)
```

## Figure S12: Cbf1 + Pho4 LASSO magnitudes
```{r}
dfVar = bind_rows(fread("~/Google Drive/Flanks_data/dfVar_cbf1.txt", header =T) %>% mutate(protein = "Cbf1"),
                  fread("~/Google Drive/Flanks_data/dfVar_pho4.txt", header =T) %>% mutate(protein = "Pho4")) %>%
  group_by(flank) %>%
  mutate(pass = findSplitNN(flank)) %>% 
  filter(pass == T) %>%
  ungroup()

dfSpace = 
  dfVar %>% 
  mutate(protein = factor(protein, levels = c("Pho4","Cbf1"))) %>%
  filter(coef != 0, elements == 2) %>% 
  group_by(protein, space) %>%
  summarise(meanVal = mean(abs(coef)), count = n()) %>%
  mutate(fractVal = meanVal/max(meanVal))

#plot
colPal = brewer.pal(9,"Set1")
p1 = ggplot(dfSpace, aes(space,fractVal)) +
  presentation +
  geom_bar(aes(fill = protein),stat = "identity", position = "dodge") +
  theme(aspect.ratio = 1,
        legend.key.size = unit(0.2, "cm")) +
  ylab("Relative mean absolute coefficient") +
  xlab("Number of gapped positions") +
  scale_fill_manual("", values = colPal[1:2])

p2 = ggplot(dfVar %>% 
              mutate(elements = ifelse(elements == 1, "mononucleotide","dinucleotide"),
                     elements = factor(elements, levels = c("mononucleotide","dinucleotide")),
                     protein = factor(protein, levels = c("Pho4", "Cbf1")))) +
  presentation +
  theme(aspect.ratio = 1,
        legend.key.size = unit(0.3,"cm")) +
  geom_boxplot(aes(protein,coef,color = as.factor(elements)), size = 0.1, outlier.size = 0.25, position = "dodge") +
  ylab("Model coefficient") +
  xlab("") +
  scale_color_manual("", values = colPal[3:4])
  
S12 = cowplot::plot_grid(p2,p1,nrow = 2,scale = c(0.98,1), align = "v")  
ggsave("~/Flanks/Images/S12.png", plot = S12, height = 10, width = 10, units = "cm")  
ggsave("~/Flanks/Images/S12.eps", plot = S12, height = 10, width = 10, units = "cm") 

# analysis of coef differences
dfVar %>% 
  group_by(elements) %>% 
  summarise(minval = min(coef),
            maxval = max(coef))
```

## Figure S13: All titration measurement correlations
```{r}
refs =
  bind_rows(std_kd %>% 
              select(flank, protein, stdE) %>% 
              mutate(source = "present",
                     protein = ifelse(protein == "pho4", "Pho4", "Cbf1")),
            fread("~/Google\ Drive/Flanks_data/Nat_gen_titration.txt", header = T) %>% 
              tbl_df() %>% 
              select(flank,stdE = Maerkl_ddG) %>% 
              mutate(protein = "Pho4",
                     source = "Rajkumar et al."),
            fread("~/Google\ Drive/Flanks_data/Science_titration.txt", header = F) %>% 
              mutate(flank = paste0("ATTTT",V1,"TT"),
                     source = "Maerkl et al.") %>% 
              select(flank,protein=V3, stdE = V2, source)) %>% 
  group_by(protein,source) %>% 
  mutate(stdE = stdE-min(stdE)) %>% 
  ungroup()
    
# NN-complete
corr_mat1 = 
  refs %>% 
  left_join(.,model_outputs %>% select(flank, protein, .fitted = scaled_ddG)) %>% 
  distinct() %>% 
  mutate(model = "neural network",
         rep = 1)

# raw measurements
corr_mat2 = 
  refs %>% 
  left_join(.,counts.df %>% select(flank, protein, .fitted = ddG, rep) %>% mutate(protein = ifelse(protein == "pho4", "Pho4", "Cbf1"))) %>%
  mutate(model = "unprocessed")

corr_full = 
  bind_rows(corr_mat1, corr_mat2) %>% 
  mutate(model = factor(model, levels = c("unprocessed","neural network")),
         protein = factor(protein, levels = c("Pho4", "Cbf1")),
         source = factor(source, levels = c("present","Rajkumar et al.","Maerkl et al.")))

#write.table(corr_full, "~/Desktop/ref_val.txt", col.names = T, row.names = F, quote = F, sep = "\t")

labelDf = 
  corr_full %>% 
  group_by(protein, model, source) %>% 
  summarise(r2 = cor(stdE,.fitted)^2,
            minval = min(stdE),
            maxval = max(stdE)) %>% 
  mutate(r2 = round(r2, 2),
         range = maxval-minval,
         yVal = minval + (0.1* range))

colPal = brewer.pal(9,"Set1")
S13 = ggplot(corr_full) +
  presentation + 
  theme(aspect.ratio = 1,
        legend.position = "none") +
  geom_point(aes(.fitted,stdE, color = source), size = 0.25) +
  facet_grid(source+protein ~ model, scales = "free") +
  geom_label(data = labelDf, aes(x = 1, y = yVal, label = r2), 
             inherit.aes = F, size = 2, 
             label.padding = unit(0.1, "lines"),
             label.r = unit(0.1, "lines")) +
  ylab(expression(bold(paste("Titration ", Delta,Delta, "G, kcal/mol")))) +
  xlab(expression(bold(paste("Sequencing-based ", Delta, Delta, "G, kcal/mol")))) +
  scale_color_manual("",values = colPal[1:3])

ggsave("~/Flanks/Images/S13.png", plot = S13, height = 12, width = 8, units = "cm") 
ggsave("~/Flanks/Images/S13.eps", plot = S13, height = 12, width = 8, units = "cm") 
```

## Figure S14: Pho4 transcription rate and induction
```{r}
rateVal = 
  fread("~/Google\ Drive/Flanks_data/transcriptionRate.txt", header = F, sep = "\t", stringsAsFactors = F) %>%
  transmute(ID = V1, seq = V2, rate = V3, std.error = V4) %>%
  mutate(flank = paste0(substring(seq,1,5),substring(seq,12,16))) %>%
  left_join(., countsNN_scaled %>% filter(protein == "pho4") %>% select(flank, scaled_dG))

cor(rateVal$rate,rateVal$scaled_dG)^2
lm(rate ~ scaled_dG, data = rateVal) %>% summary()

# P1 = rate plot
p1 = ggplot(rateVal, aes(scaled_dG, rate)) +
  geom_errorbar(aes(x = scaled_dG, ymax = rate + std.error, ymin = rate - std.error), size = 0.2) +
  geom_point(size = 0.01) +
  presentation +
  theme(aspect.ratio = 1) +
  ylab("Transcription rate, AU") +
  xlab(expression(bold(paste("Sequencing ", Delta, "G, kcal/mol"))))

expVal = 
  fread("~/Google\ Drive/Flanks_data/NARexpression.txt", header = T, sep = "\t") %>%
  mutate(flank = paste("ATC",up,down,"TGC",sep = ""),
         induction = c0/c10000) %>%
  select(flank,induction) %>%
  left_join(.,countsNN_scaled %>% filter(protein == "pho4") %>% select(flank, scaled_dG))

cor(expVal$induction,expVal$scaled_dG)^2
lm(induction ~ scaled_dG, data = expVal) %>% summary()

# P2: induction plot
p2 = ggplot(expVal,aes(scaled_dG, induction)) +
  presentation +
  geom_point(size = 0.01) +
  theme(aspect.ratio = 1) +
  ylab("Induction, fold change") +
  xlab(expression(bold(paste("Sequencing ", Delta, "G, kcal/mol"))))

S14 = cowplot::plot_grid(p1,p2,nrow=1,scale = c(1,1))

ggsave("~/Flanks/Images/S14.png", plot = S14, height = 5, width = 8, units = "cm")
ggsave("~/Flanks/Images/S14.eps", plot = S14, height = 5, width = 8, units = "cm")
```

## Figure S15: landscapes
```{r}
shockDf = 
  bind_rows(fread(paste0("~/Google\ Drive/Flanks_data/shock_pho4.txt"), header = T) %>% mutate(protein = "pho4"),
            fread(paste0("~/Google\ Drive/Flanks_data/shock_cbf1.txt"), header = T) %>% mutate(protein = "cbf1")) %>%
  tbl_df() %>% 
  mutate(protein = ifelse(protein == "pho4","Pho4","Cbf1"),
         protein = factor(protein, levels = c("Pho4","Cbf1")))

# circle plot (only ChIP)
S15 = ggplot(shockDf) +
  theme_bw() +
  geom_point(aes(t,cc,color=ddG), size = 0.5) +
  coord_polar() +
  scale_color_gradient2(expression(bold(paste(Delta,,Delta,"G, kcal/mol"))),
                        low = "#0057E7", 
                        high = "#D62D20", 
                        mid = "gray90", 
                        midpoint = 0,
                        breaks = -2:1) +
  theme(aspect.ratio = 1, 
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_blank(),
        legend.key.size = unit(0.3,"cm")) +
  scale_y_continuous(breaks = 0:10) +
  facet_wrap(~ protein, nrow = 1)

ggsave("~/Flanks/Images/S15.png", plot = S15, height = 8, width = 15, units = "cm", dpi = 300)
```

## S16: landscape density
```{r}
shockDf = 
  bind_rows(fread(paste0("~/Google\ Drive/Flanks_data/shock_pho4.txt"), header = T) %>% mutate(protein = "pho4"),
            fread(paste0("~/Google\ Drive/Flanks_data/shock_cbf1.txt"), header = T) %>% mutate(protein = "cbf1")) %>%
  tbl_df() %>% 
  mutate(protein = ifelse(protein == "pho4","Pho4","Cbf1"),
         protein = factor(protein, levels = c("Pho4","Cbf1")))

colPal = colorRampPalette(brewer.pal(9,"YlOrRd"))(10)
S16 = ggplot(shockDf %>% 
         filter(cc < 10) %>% 
         mutate(cc = paste0("Hamming dist. = ",cc))) +
  presentation +
  theme(aspect.ratio = 1,
        legend.position = "none") +
  geom_density(aes(ddG,fill = as.factor(cc)), size = 0.25) +
  facet_wrap(~protein+cc,nrow = 4) +
  scale_fill_manual(values = colPal[1:10]) +
  ylab("Density") +
  xlab(expression(bold(paste(Delta, Delta, "G, kcal/mol"))))

ggsave("~/Flanks/Images/S16.png", plot = S16, height = 15, width = 15, units = "cm", dpi = 600)
ggsave("~/Flanks/Images/S16.eps", plot = S16, height = 15, width = 15, units = "cm", dpi = 600)
```

## S17: Hamming distance summary
```{r}
overlayDf = 
  left_join(bind_rows(fread(paste0("~/Google\ Drive/Flanks_data/shock_pho4.txt"), header = T) %>% mutate(protein = "pho4"),
                      fread(paste0("~/Google\ Drive/Flanks_data/shock_cbf1.txt"), header = T) %>% mutate(protein = "cbf1")) %>%
                      tbl_df(),
            chip.gen.full %>% select(flank,pho4,cbf1) %>% gather(protein,occ,pho4,cbf1)) %>% 
  mutate(protein = ifelse(protein == "pho4","Pho4","Cbf1"),
         protein = factor(protein, levels = c("Pho4","Cbf1"))) %>% 
  group_by(protein) %>% 
  mutate(relOcc = occ/max(occ, na.rm = T)) %>% 
  ungroup()

labelDf = 
  overlayDf %>% 
  mutate(cc = factor(cc, levels = 0:10)) %>% 
  group_by(cc,protein) %>% 
  summarise(ysum = sum(occ, na.rm = T), 
            meanval = mean(ddG)) %>% 
  ungroup() %>% 
  mutate(meanval = round(meanval,2), 
         colScale = meanval)

S17 = ggplot(overlayDf %>% mutate(cc = factor(cc, levels = 0:10)) %>% group_by(cc,protein) %>% summarise(meanval = sum(occ, na.rm = T))) +
  geom_bar(aes(cc, meanval, group=cc), stat = "identity", fill = "black",width = 0.85) +
  geom_label(data = labelDf, aes(cc, ysum, label=meanval, fill = colScale), 
             inherit.aes = F, 
             vjust = 0.5, 
             size = 2, 
             color = "black",
             label.padding = unit(0.1, "lines"),
             label.r = unit(0.01, "lines")) +
  presentation +
  theme(aspect.ratio = 1/3,
        legend.key.size = unit(0.2,"cm")) +
  ylab("Cummulative ChIP enrichment") +
  xlab("Hamming distance from highest affinity sequence") +
  facet_grid(protein ~ ., scales = "free") +
  theme(aspect.ratio = 0.5) +
  scale_fill_gradient2(expression(bold(paste("Mean ",Delta, Delta,"G, kcal/mol"))),low = "#0057E7", high = "#D62D20", mid = "gray90", midpoint = 0)

ggsave("~/Flanks/Images/S17.png", plot = S17, height = 10, width = 11.5, units = "cm")
ggsave("~/Flanks/Images/S17.eps", plot = S17, height = 10, width = 11.5, units = "cm")

```






